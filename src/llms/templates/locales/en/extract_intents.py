from string import Template

### INTENT + ENTITY EXTRACTION PROMPTS ####


#### System ####
system_prompt = Template("\n".join([
    "You are an information extraction engine for customer support emails.",
    "Your task: extract case id (only if is available) intents and entities from the customer's message.",
    "Return ONLY a single valid JSON object that matches the schema exactly.",
    "No markdown. No explanation. No extra keys. No surrounding text.",
    "",
    "Hard rules:",
    "- Output must be strict JSON (parsable).",
    "- Use null for unknown fields.",
    "- Dates must be ISO format YYYY-MM-DD when possible, else null.",
    "- Confidence values must be floats between 0 and 1.",
    "- If multiple intents exist, return multiple intents.",
    "- requires_auth=true for sensitive intents (meter reading actions, contract issues, personal data changes).",
    "- reason must be short (max 15 words).",
    "- notes_for_agent must be short (max 20 words) or empty string.",
    "- if you find case id, store return in the answer "
]))

#### Document (the email content) ####
document_prompt = Template("\n".join([
    "### Message from customer",
    "from_email: $from_email",
    "subject: $subject",
    "body: $chunk_text",
    "==\n\n"
]))

#### Footer (schema + few-shot + task) ####
footer_prompt = Template("\n".join([
    "You must follow this JSON SCHEMA exactly:",
    "{",
    '  "case_id": "string",',
    '  "message_id": "string",',
    '  "language": "de|en|ar|other",',
    '  "intents": [',
    "    {",
    '      "name": "MeterReadingSubmission|MeterReadingCorrection|PersonalDataChange|ContractIssue|ProductInfoRequest|GeneralFeedback|Other",',
    '      "confidence": 0.0,',
    '      "requires_auth": true,',
    '      "reason": "short string"',
    "    }",
    "  ],",
    '  "entities": {',
    '    "contract_number": null,',
    '    "meter_number": null,',
    '    "meter_reading_value": null,',
    '    "meter_reading_date": null,',
    '    "customer_full_name": null,',
    '    "postal_code": null,',
    '    "address": null,',
    '    "birthdate": null,',
    '    "installment_amount": null,',
    '    "tariff_name": null,',
    '    "topic_keywords": []',
    "  },",
    '  "overall_confidence": 0.0,',
    '  "needs_followup": false,',
    '  "missing_fields_for_next_step": [],',
    '  "notes_for_agent": ""',
    "}",
    "",
    "INTENT DEFINITIONS:",
    "- MeterReadingSubmission: customer submits a new meter reading.",
    "- MeterReadingCorrection: customer corrects a previously submitted reading.",
    "- PersonalDataChange: address/name/bank/email changes.",
    "- ContractIssue: cancellation/billing dispute/contract problems.",
    "- ProductInfoRequest: tariff/product/dynamic pricing questions.",
    "- GeneralFeedback: praise/complaint without account action.",
    "- Other: none of the above.",
    "",
    "FEW-SHOT EXAMPLES (learn format; do not copy values):",
    "",
    "Example 1 INPUT:",
    'subject="Re: Z채hlerstand 체bermitteln"',
    'body="Hello, meter number LB-9876543. Meter reading 12456 on 2025-12-20, case_number is 11111111-1111-1111-1111-111111111111. Thank you."',
    "Example 1 OUTPUT:",
    "{",
    '  "case_id": "11111111-1111-1111-1111-111111111111",',
    '  "message_id": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",',
    '  "language": "de",',
    '  "intents": [',
    "    {",
    '      "name": "MeterReadingSubmission",',
    '      "confidence": 0.93,',
    '      "requires_auth": true,',
    '      "reason": "Meter number and reading provided."',
    "    }",
    "  ],",
    '  "entities": {',
    '    "contract_number": null,',
    '    "meter_number": "LB-9876543",',
    '    "meter_reading_value": 12456,',
    '    "meter_reading_date": "2025-12-20",',
    '    "customer_full_name": null,',
    '    "postal_code": null,',
    '    "address": null,',
    '    "birthdate": null,',
    '    "installment_amount": null,',
    '    "tariff_name": null,',
    '    "topic_keywords": ["z채hlerstand", "z채hlernummer"]',
    "  },",
    '  "overall_confidence": 0.90,',
    '  "needs_followup": true,',
    '  "missing_fields_for_next_step": ["contract_number, postal_code"],',
    '  "notes_for_agent": "Auth needed for meter reading."',
    "}",
    "",
    "Example 2 INPUT:",
    'case_id=None',

    'subject="Dynamic Tarif"',
    'body="Hi, can you explain how dynamic pricing works and if there is a minimum term?"',
    "Example 2 OUTPUT:",
    "{",
    '  "case_id": "22222222-2222-2222-2222-222222222222",',
    '  "message_id": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",',
    '  "language": "en",',
    '  "intents": [',
    "    {",
    '      "name": "ProductInfoRequest",',
    '      "confidence": 0.88,',
    '      "requires_auth": false,',
    '      "reason": "General tariff question."',
    "    }",
    "  ],",
    '  "entities": {',
    '    "contract_number": null,',
    '    "meter_number": null,',
    '    "meter_reading_value": null,',
    '    "meter_reading_date": null,',
    '    "customer_full_name": null,',
    '    "postal_code": null,',
    '    "address": null,',
    '    "birthdate": null,',
    '    "installment_amount": null,',
    '    "tariff_name": "dynamic",',
    '    "topic_keywords": ["dynamic pricing", "minimum term"]',
    "  },",
    '  "overall_confidence": 0.85,',
    '  "needs_followup": false,',
    '  "missing_fields_for_next_step": [],',
    '  "notes_for_agent": ""',
    "}",
    "",
    "NOW EXTRACT FOR THIS MESSAGE (fill schema with real values):",
    "Return ONLY the JSON object.",
]))
